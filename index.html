<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>청각장애인 스마트워치 앱 WBS 대시보드 (Firebase Sync)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Firebase SDK (Compat Version for UMD) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; -webkit-print-color-adjust: exact; }
            .shadow-sm { box-shadow: none !important; border: 1px solid #ddd; }
            .bg-gray-50 { background-color: white !important; }
        }
        
        .col-task { width: 35%; }
        .col-assignee { width: 15%; }
        .col-period { width: 15%; }
        .col-dod { width: 15%; }
        .col-status { width: 10%; }
        .col-last-mod { width: 10%; } /* 추가된 컬럼 */

        /* 간트 차트 상태별 패턴 */
        .gantt-bar-done { background-color: #22c55e; } /* solid green */
        .gantt-bar-progress { 
            background: repeating-linear-gradient(
                45deg,
                #3b82f6,
                #3b82f6 10px,
                #60a5fa 10px,
                #60a5fa 20px
            );
        }
        .gantt-bar-todo { background-color: #9ca3af; opacity: 0.6; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        // --- Firebase 설정 (사용자 설정 필요) ---
        // 주의: 이곳에 실제 Firebase 프로젝트 설정을 입력해야 동기화가 작동합니다.
        // 현재는 더미 값이므로 실행 시 오류가 발생하며 데모 모드로 동작합니다.
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Firebase 초기화
        let db = null;
        let auth = null;
        let isFirebaseInitialized = false;

        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            // Config가 더미인지 확인 (간단한 체크)
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                db = firebase.firestore();
                auth = firebase.auth();
                isFirebaseInitialized = true;
            } else {
                console.warn("Firebase Config가 설정되지 않았습니다. 데모 모드로 실행합니다.");
            }
        } catch (e) {
            console.error("Firebase Initialization Error:", e);
        }

        const { useState, useMemo, useRef, useEffect } = React;

        // --- 아이콘 컴포넌트 ---
        const Icon = ({ path, size = 18, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            Clock: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} />,
            CheckSquare: (p) => <Icon {...p} path={<><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></>} />,
            BarChart2: (p) => <Icon {...p} path={<><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></>} />,
            ChevronRight: (p) => <Icon {...p} path={<polyline points="9 18 15 12 9 6"/>} />,
            AlertCircle: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>} />,
            CheckCircle2: (p) => <Icon {...p} path={<><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></>} />,
            User: (p) => <Icon {...p} path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />,
            Download: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></>} />,
            Printer: (p) => <Icon {...p} path={<><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></>} />,
            Filter: (p) => <Icon {...p} path={<><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></>} />,
            Google: (p) => <Icon {...p} path={<><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-5v-2h3.26c-.34-1.63-1.78-2.85-3.26-2.85-1.93 0-3.5 1.57-3.5 3.5s1.57 3.5 3.5 3.5c1.47 0 2.75-.91 3.25-2.15h2.06c-.63 2.37-2.79 4.15-5.31 4.15C8.14 20 5 16.86 5 13s3.14-8 8-8c2.06 0 3.93.79 5.35 2.08l-2.83 2.83C14.86 9.39 13.51 9 12 9c-2.21 0-4 1.79-4 4s1.79 4 4 4c1.86 0 3.41-1.28 3.86-3h-1.86v-2z"/></>} />,
            Lock: (p) => <Icon {...p} path={<><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>} />,
            Refresh: (p) => <Icon {...p} path={<><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></>} />
        };

        const PHASES = [
            { id: 'p0', title: 'Phase 0. 기획/법무/기술 선행 (리스크 차단)', color: 'bg-gray-100 text-gray-800', barColor: 'bg-gray-400' },
            { id: 'p1', title: 'Phase 1. 개발/마케팅 병행 (MVP & Identity)', color: 'bg-blue-50 text-blue-700', barColor: 'bg-blue-500' },
            { id: 'p2', title: 'Phase 2. 운영준비/데이터/안정화', color: 'bg-indigo-50 text-indigo-700', barColor: 'bg-indigo-500' },
            { id: 'p3', title: 'Phase 3. 행정/제안서 집중 (플랜B 포함)', color: 'bg-orange-50 text-orange-700', barColor: 'bg-orange-500' },
            { id: 'p4', title: 'Phase 4. 최종 마감/접수', color: 'bg-purple-50 text-purple-700', barColor: 'bg-purple-500' },
        ];

        // 초기 데이터 (Seed)
        const INITIAL_TASKS = [
            { id: '1', phase: 'p0', task: 'Kick-off 및 PoC 착수', assignee: { display: 'PM/Dev', roles: ['PM', 'Dev'] }, start: '2025-12-18', end: '2025-12-24', status: 'Done', dod: '회의록, PoC 계획' },
            { id: '2', phase: 'p0', task: '[기획] PRD/요구사항 확정 & 범위 컷라인', assignee: { display: 'Plan', roles: ['Plan'] }, start: '2025-12-19', end: '2025-12-31', status: 'In Progress', dod: 'PRD 1.0, 제외기능목록' },
            { id: '3', phase: 'p0', task: '[법무] 119 연계(자동배제) & 위치/개인정보 동의', assignee: { display: 'Legal', roles: ['Legal'] }, start: '2025-12-20', end: '2026-01-05', status: 'Done', dod: '책임정책, 동의 약관' },
            { id: '4', phase: 'p0', task: '[기술] 백그라운드 제약 검증 & 스토어 권한 설계', assignee: { display: 'Dev(Watch)', roles: ['Dev'] }, start: '2025-12-23', end: '2026-01-05', status: 'Todo', dod: '제약 체크, 권한 정의' },
            { id: '5', phase: 'p0', task: '[기획] 접근성/가독성(폰트/진동) 표준안', assignee: { display: 'Plan/Design', roles: ['Plan', 'Design'] }, start: '2026-01-02', end: '2026-01-05', status: 'Todo', dod: 'UX 가이드 표준안' },
            { id: '6', phase: 'p1', task: '[디자인] 워치 UI/UX (오탐 대응 포함)', assignee: { display: 'Design', roles: ['Design'] }, start: '2026-01-06', end: '2026-01-15', status: 'Todo', dod: 'Figma, 취소UX' },
            { id: '7', phase: 'p1', task: '[기획] 데이터 흐름도 & 파기/보관 정책', assignee: { display: 'Plan', roles: ['Plan'] }, start: '2026-01-06', end: '2026-01-15', status: 'Todo', dod: '개인정보 흐름도' },
            { id: '8', phase: 'p1', task: '[개발] 소리 인식 모델 최적화 (TFLite)', assignee: { display: 'Dev(Watch)', roles: ['Dev'] }, start: '2026-01-06', end: '2026-01-20', status: 'Todo', dod: '모델 파일 (.tflite)' },
            { id: '9', phase: 'p1', task: '[기획] 알림 문구/오탐 취소/책임고지 카피 확정', assignee: { display: 'Plan', roles: ['Plan'] }, start: '2026-01-10', end: '2026-01-17', status: 'Todo', dod: '문구 표준안, 화면매핑' },
            { id: '10', phase: 'p1', task: '[마케팅] 네이밍/메시지 (법무 검토 후 진행)', assignee: { display: 'Mkt', roles: ['Mkt'] }, start: '2026-01-11', end: '2026-01-17', status: 'Todo', dod: '브랜드 가이드(1p)' },
            { id: '11', phase: 'p1', task: '[개발] 최소 서버/로그/보호자 연동 API', assignee: { display: 'Dev(Server)', roles: ['Dev'] }, start: '2026-01-16', end: '2026-01-26', status: 'Todo', dod: 'API, 로그 스키마' },
            { id: '12', phase: 'p1', task: '[개발] 워치 알림/진동 로직 구현', assignee: { display: 'Dev(Watch)', roles: ['Dev'] }, start: '2026-01-16', end: '2026-01-26', status: 'Todo', dod: '기능 구현 완료' },
            { id: '13', phase: 'p2', task: '[운영] VOC 접수 채널/태깅/우선순위(SLA) 세팅', assignee: { display: 'Ops', roles: ['Ops'] }, start: '2026-01-27', end: '2026-02-05', status: 'Todo', dod: 'VOC시트, SLA정의' },
            { id: '14', phase: 'p2', task: '[운영] 베타 참여자 모집/동의/기기 지급/교육', assignee: { display: 'PM/Ops', roles: ['PM', 'Ops'] }, start: '2026-01-27', end: '2026-02-09', status: 'Todo', dod: '명단, 동의서, 기기전달' },
            { id: '15', phase: 'p2', task: '[테스트] KPI 산출(오탐률/반응속도/배터리/동작조건)', assignee: { display: 'QA', roles: ['QA'] }, start: '2026-02-01', end: '2026-02-12', status: 'Todo', dod: 'KPI표, 측정조건, 배터리 영향, 권한 제약' },
            { id: '16', phase: 'p2', task: '[운영] 설치/오탐 대응 가이드 (평가 대비)', assignee: { display: 'Ops', roles: ['Ops'] }, start: '2026-02-01', end: '2026-02-10', status: 'Todo', dod: '사용자 매뉴얼' },
            { id: '17', phase: 'p2', task: '[테스트] 통합 빌드 & 변수(거리/소음) 테스트', assignee: { display: 'QA/Dev', roles: ['QA', 'Dev'] }, start: '2026-02-01', end: '2026-02-09', status: 'Todo', dod: '시험 성적서/리포트' },
            { id: '18', phase: 'p2', task: '[운영] 베타 테스트 (사용자 데이터 확보)', assignee: { display: 'PM/Ops', roles: ['PM', 'Ops'] }, start: '2026-02-10', end: '2026-02-20', status: 'Todo', dod: '만족도 조사 결과' },
            { id: '19', phase: 'p2', task: '[마케팅] 평가용 데모 시나리오 & FAQ', assignee: { display: 'Mkt/Plan', roles: ['Mkt', 'Plan'] }, start: '2026-02-10', end: '2026-02-15', status: 'Todo', dod: '시연 시나리오' },
            { id: '20', phase: 'p3', task: '[행정] 공모 서류 체크리스트 & 원가 의뢰', assignee: { display: 'Admin/PM', roles: ['Admin', 'PM'] }, start: '2026-02-03', end: '2026-02-07', status: 'Todo', dod: '제출 리스트, 견적요청' },
            { id: '21', phase: 'p3', task: '[마케팅] 제안서/제품사양서/소개서 작성', assignee: { display: 'Mkt/Plan', roles: ['Mkt', 'Plan'] }, start: '2026-02-10', end: '2026-02-28', status: 'Todo', dod: '제안서, 카탈로그' },
            { id: '22', phase: 'p3', task: '[행정/PM] 평가 대응 Q&A 리스트 (심사위원용)', assignee: { display: 'PM/Mkt', roles: ['PM', 'Mkt'] }, start: '2026-02-15', end: '2026-02-25', status: 'Todo', dod: 'Q&A 20문 1장' },
            { id: 23, phase: 'p3', task: '[개발] 스토어 배포 & 심사 대응 (반려대비)', assignee: { display: 'Dev', roles: ['Dev'] }, start: '2026-02-15', end: '2026-02-28', status: 'Todo', dod: '심사 통과/소명자료' },
            { id: 24, phase: 'p3', task: '[행정] 원가계산 수령 or 약정서(플랜B)', assignee: { display: 'Admin', roles: ['Admin'] }, start: '2026-02-20', end: '2026-02-28', status: 'Todo', dod: '원가분석서/약정서' },
            { id: 25, phase: 'p3', task: '[행정] 제출 패키지 제작(제본/USB/인감)', assignee: { display: 'Admin', roles: ['Admin'] }, start: '2026-02-24', end: '2026-03-02', status: 'Todo', dod: '제출 패키지 완본' },
            { id: 26, phase: 'p4', task: '[마케팅] 평가 리허설 (데모/Q&A/정합성)', assignee: { display: 'Mkt/PM', roles: ['Mkt', 'PM'] }, start: '2026-03-01', end: '2026-03-03', status: 'Todo', dod: '리허설 완료' },
            { id: 27, phase: 'p4', task: '[행정] 최종 현장 접수 (대리인 위임장)', assignee: { display: 'Admin', roles: ['Admin'] }, start: '2026-03-04', end: '2026-03-07', status: 'Todo', dod: '접수증 (15:00 마감)' },
        ];

        // --- 유틸리티 ---
        const getStatusColor = (status) => {
            if (status === 'Done') return 'bg-green-100 text-green-700 border-green-200';
            if (status === 'In Progress') return 'bg-blue-100 text-blue-700 border-blue-200';
            return 'bg-gray-100 text-gray-500 border-gray-200';
        };

        const getGanttBarClass = (status) => {
            if (status === 'Done') return 'gantt-bar-done';
            if (status === 'In Progress') return 'gantt-bar-progress';
            return 'gantt-bar-todo';
        };

        const getDday = (target) => {
            const today = new Date();
            today.setHours(0,0,0,0);
            const targetDate = new Date(target);
            targetDate.setHours(0,0,0,0);
            return Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
        };

        // --- 메인 컴포넌트 ---
        function ProjectDashboard() {
            const [viewMode, setViewMode] = useState('list');
            const [tasks, setTasks] = useState([]); // 초기값 빈 배열, Firestore 로드
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [demoMode, setDemoMode] = useState(false); // 데모 모드 상태
            const dashboardRef = useRef(null);

            // [필터 State]
            const [statusFilter, setStatusFilter] = useState({ 'Todo': true, 'In Progress': true, 'Done': true });
            const [assigneeFilter, setAssigneeFilter] = useState({});

            // 1. Auth Listener
            useEffect(() => {
                if (!isFirebaseInitialized) {
                    setLoading(false);
                    setDemoMode(true);
                    setTasks(INITIAL_TASKS);
                    return;
                }
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    setUser(u);
                });
                return () => unsubscribe();
            }, []);

            // 2. Firestore Subscribe (Realtime)
            useEffect(() => {
                if (!isFirebaseInitialized) {
                    // Firebase 초기화 실패 시 바로 종료
                    return;
                }
                
                try {
                    const unsubscribe = db.collection('tasks').orderBy('start').onSnapshot(snapshot => {
                        const loadedTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        
                        // 만약 데이터가 아예 없으면 초기화 (Seed)
                        if (loadedTasks.length === 0) {
                            setTasks(INITIAL_TASKS); // 화면엔 일단 보여줌
                            // DB 저장은 별도 함수로 (자동 저장은 위험할 수 있으니)
                        } else {
                            setTasks(loadedTasks);
                        }
                        setLoading(false);
                    }, (error) => {
                        console.warn("Firestore 연결 실패 (아마도 설정/권한 문제):", error.code);
                        setDemoMode(true);
                        setTasks(INITIAL_TASKS);
                        setLoading(false);
                    });
                    return () => unsubscribe();
                } catch (e) {
                    console.error("Firestore Error:", e);
                    setDemoMode(true);
                    setTasks(INITIAL_TASKS);
                    setLoading(false);
                }
            }, []);

            // 담당자 목록 추출 (동적)
            const allAssignees = useMemo(() => {
                const assignees = new Set();
                tasks.forEach(t => {
                    if (t.assignee && t.assignee.roles) {
                        t.assignee.roles.forEach(r => assignees.add(r));
                    }
                });
                return Array.from(assignees).sort();
            }, [tasks]);

            // 필터 초기화 (데이터 로드 시 한 번만)
            useEffect(() => {
                if (allAssignees.length > 0 && Object.keys(assigneeFilter).length === 0) {
                    const initial = {};
                    allAssignees.forEach(a => initial[a] = true);
                    setAssigneeFilter(initial);
                }
            }, [allAssignees]);

            // [로그인/로그아웃]
            const handleLogin = async () => {
                if (demoMode) {
                    alert("데모 모드에서는 로그인이 불가능합니다. Firebase 설정을 확인해주세요.");
                    return;
                }
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    await auth.signInWithPopup(provider);
                } catch (error) {
                    console.error("Login Failed:", error);
                    alert("로그인 실패: " + error.message);
                }
            };
            const handleLogout = () => auth.signOut();

            // [DB 초기화 - 관리자용]
            const initializeDB = async () => {
                if (demoMode) {
                    alert("데모 모드에서는 DB 초기화가 불가능합니다.");
                    return;
                }
                if (!user) return alert("로그인이 필요합니다.");
                if (!confirm("데이터베이스를 초기화하시겠습니까? 기존 데이터가 있다면 덮어쓰지 않고 누락된 것만 추가합니다.")) return;

                const batch = db.batch();
                INITIAL_TASKS.forEach(task => {
                    const docRef = db.collection('tasks').doc(task.id);
                    // set with merge: true (없으면 생성, 있으면 유지)
                    batch.set(docRef, task, { merge: true }); 
                });
                
                try {
                    await batch.commit();
                    alert("초기화 완료!");
                } catch (e) {
                    console.error(e);
                    alert("초기화 실패");
                }
            };

            // [상태 업데이트]
            const updateStatus = async (id, newStatus) => {
                if (demoMode) {
                    alert("데모 모드입니다. 변경 사항이 저장되지 않습니다.");
                    // 로컬 반영 (UI 테스트용)
                    setTasks(prev => prev.map(t => t.id === id ? { ...t, status: newStatus } : t));
                    return;
                }

                if (!user) {
                    alert("상태를 변경하려면 로그인이 필요합니다.");
                    return;
                }

                const task = tasks.find(t => t.id === id);
                if (!task || task.status === newStatus) return;

                const oldStatus = task.status;
                const now = firebase.firestore.FieldValue.serverTimestamp();

                try {
                    // 1. Task Update
                    await db.collection('tasks').doc(id).update({
                        status: newStatus,
                        updatedAt: now,
                        updatedBy: {
                            uid: user.uid,
                            name: user.displayName,
                            email: user.email
                        }
                    });

                    // 2. Audit Log (별도 컬렉션)
                    await db.collection('task_audit_logs').add({
                        taskId: id,
                        taskName: task.task,
                        oldStatus: oldStatus,
                        newStatus: newStatus,
                        changedAt: now,
                        changedBy: {
                            uid: user.uid,
                            name: user.displayName,
                            email: user.email
                        }
                    });

                } catch (error) {
                    console.error("Update failed:", error);
                    alert("저장 실패: 권한이 없거나 네트워크 오류입니다.");
                }
            };

            // [필터 핸들러]
            const toggleStatusFilter = (status) => setStatusFilter(prev => ({ ...prev, [status]: !prev[status] }));
            const toggleAssigneeFilter = (assignee) => setAssigneeFilter(prev => ({ ...prev, [assignee]: !prev[assignee] }));
            const toggleAllAssignees = (checked) => {
                const next = {};
                allAssignees.forEach(a => next[a] = checked);
                setAssigneeFilter(next);
            };

            // [필터링 로직]
            const filteredTasks = useMemo(() => {
                return tasks.filter(task => {
                    if (!statusFilter[task.status]) return false;
                    // 데이터 로드 전에는 assignee가 없을 수 있음
                    if (!task.assignee || !task.assignee.roles) return true;
                    return task.assignee.roles.some(role => assigneeFilter[role]);
                });
            }, [tasks, statusFilter, assigneeFilter]);

            // [진행률]
            const progress = useMemo(() => {
                if (filteredTasks.length === 0) return 0;
                const done = filteredTasks.filter(t => t.status === 'Done').length;
                return Math.round((done / filteredTasks.length) * 100);
            }, [filteredTasks]);

            const targetDate = '2026-03-02';
            const dDay = getDday(targetDate);

            const currentPhase = useMemo(() => {
                const todayStr = new Date().toISOString().split('T')[0];
                const activeTask = tasks.find(t => t.start <= todayStr && t.end >= todayStr);
                
                if (activeTask) {
                    const phase = PHASES.find(p => p.id === activeTask.phase);
                    return { title: phase?.title.split('.')[0] || '준비', sub: phase?.title.split('.')[1] || '' };
                }
                
                const nextTask = tasks.find(t => t.start > todayStr);
                const nextPhase = nextTask ? PHASES.find(p => p.id === nextTask.phase) : null;
                return nextPhase 
                    ? { title: nextPhase.title.split('.')[0] || '', sub: '(대기)' } 
                    : { title: '완료', sub: '' };
            }, [tasks]);

            // 날짜 표시용 유틸 (Timestamp -> String)
            const formatDate = (ts) => {
                if (!ts) return '-';
                // Firestore Timestamp
                const date = ts.toDate ? ts.toDate() : new Date(ts); 
                return `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes()}`;
            };

            const handleDownloadImage = async () => {
                if (!dashboardRef.current) return;
                try {
                    const originalOverflow = dashboardRef.current.style.overflow;
                    dashboardRef.current.style.overflow = 'visible';
                    const canvas = await html2canvas(dashboardRef.current, { scale: 2, useCORS: true, logging: false, windowWidth: dashboardRef.current.scrollWidth, windowHeight: dashboardRef.current.scrollHeight });
                    dashboardRef.current.style.overflow = originalOverflow;
                    const link = document.createElement('a');
                    link.download = `WBS_Dashboard_${new Date().toISOString().split('T')[0]}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                } catch (err) {
                    alert('이미지 저장 중 오류가 발생했습니다.');
                    console.error(err);
                }
            };

            const handlePrint = () => { window.print(); };

            if (loading) return <div className="min-h-screen flex items-center justify-center">Loading Project Data...</div>;

            return (
                <div className="min-h-screen bg-gray-50 p-6 font-sans text-gray-800" ref={dashboardRef}>
                    <div className="max-w-7xl mx-auto mb-8">
                        {/* 상단 헤더 */}
                        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                            <div>
                                <h1 className="text-2xl font-bold text-gray-900 flex items-center">
                                    <Icons.Clock className="mr-2 text-indigo-600" />
                                    청각장애인 워치앱 프로젝트 (Sync)
                                </h1>
                                <p className="text-sm text-gray-500 mt-1">
                                    <span className="font-bold text-indigo-600">Target: 3월 2일 (준비 완료)</span> | 접수마감: 3월 7일 15:00
                                </p>
                            </div>
                            <div className="flex bg-white p-1 rounded-lg border shadow-sm no-print items-center">
                                {/* 로그인 버튼 */}
                                {user ? (
                                    <div className="flex items-center mr-3 px-3 py-1 bg-green-50 text-green-700 rounded-md text-xs font-medium border border-green-100">
                                        <img src={user.photoURL} alt="User" className="w-5 h-5 rounded-full mr-2"/>
                                        {user.displayName}
                                        <button onClick={handleLogout} className="ml-2 text-gray-400 hover:text-red-500"><Icons.Lock size={12}/></button>
                                    </div>
                                ) : (
                                    <button onClick={handleLogin} className="flex items-center mr-2 px-3 py-2 text-sm font-medium text-gray-600 hover:bg-gray-100 rounded-md">
                                        <Icons.Google size={16} className="mr-2 text-red-500"/> 로그인
                                    </button>
                                )}
                                <div className="w-px bg-gray-200 mx-1 h-6"></div>

                                {/* DB 초기화 버튼 (데이터 없을 때만 노출하거나, 숨겨둠) */}
                                {!demoMode && <button onClick={initializeDB} className="px-2 text-gray-300 hover:text-gray-500" title="DB 초기화(Admin Only)"><Icons.Refresh size={14}/></button>}

                                <div className="w-px bg-gray-200 mx-1 h-6"></div>
                                <button onClick={() => setViewMode('list')} className={`px-4 py-2 text-sm font-medium rounded-md transition-all flex items-center ${viewMode === 'list' ? 'bg-indigo-50 text-indigo-700 shadow-sm' : 'text-gray-500 hover:bg-gray-50'}`}>
                                    <Icons.CheckSquare size={16} className="mr-2"/> 리스트
                                </button>
                                <button onClick={() => setViewMode('gantt')} className={`px-4 py-2 text-sm font-medium rounded-md transition-all flex items-center ${viewMode === 'gantt' ? 'bg-indigo-50 text-indigo-700 shadow-sm' : 'text-gray-500 hover:bg-gray-50'}`}>
                                    <Icons.BarChart2 size={16} className="mr-2"/> 간트
                                </button>
                                <div className="w-px bg-gray-200 mx-1 h-6"></div>
                                <button onClick={handleDownloadImage} className="px-4 py-2 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-50 hover:text-indigo-600 transition-all flex items-center" title="이미지로 저장">
                                    <Icons.Download size={16} className="mr-2"/> 저장
                                </button>
                                <button onClick={handlePrint} className="px-4 py-2 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-50 hover:text-indigo-600 transition-all flex items-center" title="PDF 저장 / 인쇄">
                                    <Icons.Printer size={16} className="mr-2"/> 인쇄
                                </button>
                            </div>
                        </div>

                        {/* 데모 모드 알림 */}
                        {demoMode && (
                            <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                                <div className="flex">
                                    <div className="flex-shrink-0">
                                        <Icons.AlertCircle size={20} className="text-yellow-400"/>
                                    </div>
                                    <div className="ml-3">
                                        <p className="text-sm text-yellow-700">
                                            <span className="font-bold">데모 모드:</span> Firebase 설정이 올바르지 않아 로컬 데이터로 동작합니다. 데이터 변경사항은 저장되지 않습니다. (index.html 파일을 열어 firebaseConfig 값을 수정해주세요.)
                                        </p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 필터 영역 */}
                        <div className="bg-white p-4 rounded-xl border shadow-sm mb-6 no-print">
                            <div className="flex flex-col md:flex-row gap-6">
                                <div className="flex-1">
                                    <h4 className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 flex items-center">
                                        <Icons.Filter size={12} className="mr-1"/> 상태 필터
                                    </h4>
                                    <div className="flex flex-wrap gap-3">
                                        {['Todo', 'In Progress', 'Done'].map(status => (
                                            <label key={status} className="inline-flex items-center text-sm cursor-pointer select-none">
                                                <input type="checkbox" className="form-checkbox h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500" checked={statusFilter[status]} onChange={() => toggleStatusFilter(status)}/>
                                                <span className="ml-2 text-gray-700">{status}</span>
                                            </label>
                                        ))}
                                    </div>
                                </div>
                                <div className="flex-[2]">
                                    <div className="flex justify-between items-center mb-2">
                                        <h4 className="text-xs font-bold text-gray-500 uppercase tracking-wider flex items-center">
                                            <Icons.User size={12} className="mr-1"/> 담당자 필터
                                        </h4>
                                        <div className="space-x-2 text-xs">
                                            <button onClick={() => toggleAllAssignees(true)} className="text-indigo-600 hover:underline">전체 선택</button>
                                            <span className="text-gray-300">|</span>
                                            <button onClick={() => toggleAllAssignees(false)} className="text-gray-500 hover:underline">전체 해제</button>
                                        </div>
                                    </div>
                                    <div className="flex flex-wrap gap-x-4 gap-y-2">
                                        {allAssignees.map(assignee => (
                                            <label key={assignee} className="inline-flex items-center text-sm cursor-pointer select-none">
                                                <input type="checkbox" className="form-checkbox h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500" checked={assigneeFilter[assignee] || false} onChange={() => toggleAssigneeFilter(assignee)}/>
                                                <span className="ml-2 text-gray-700">{assignee}</span>
                                            </label>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* 상태 카드 */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-start space-x-4">
                                <div className="p-3 rounded-lg bg-blue-100 text-blue-600"><Icons.ChevronRight size={24}/></div>
                                <div>
                                    <p className="text-sm text-gray-500 font-medium">현재 진행 단계</p>
                                    <h3 className="text-2xl font-bold text-gray-800 mt-1">{currentPhase.title}</h3>
                                    <p className="text-xs text-gray-400 mt-1">{currentPhase.sub}</p>
                                </div>
                            </div>
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-start space-x-4">
                                <div className="p-3 rounded-lg bg-green-100 text-green-600"><Icons.CheckCircle2 size={24}/></div>
                                <div>
                                    <p className="text-sm text-gray-500 font-medium">선택 항목 진행률</p>
                                    <h3 className="text-2xl font-bold text-gray-800 mt-1">{progress}%</h3>
                                    <p className="text-xs text-gray-400 mt-1">{filteredTasks.filter(t => t.status === 'Done').length} / {filteredTasks.length} 완료</p>
                                </div>
                            </div>
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-start space-x-4">
                                <div className="p-3 rounded-lg bg-orange-100 text-orange-600"><Icons.AlertCircle size={24}/></div>
                                <div><p className="text-sm text-gray-500 font-medium">D-Day (준비완료)</p><h3 className="text-2xl font-bold text-gray-800 mt-1">D{dDay >= 0 ? '-' + dDay : '+' + Math.abs(dDay)}</h3><p className="text-xs text-gray-400 mt-1">목표일: 2026-03-02</p></div>
                            </div>
                        </div>

                        {/* 메인 뷰 */}
                        {viewMode === 'list' ? (
                            <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                                <table className="min-w-full divide-y divide-gray-200 table-fixed">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider col-task">Phase / Task</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider col-assignee">담당자</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider col-period">기간</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider col-dod">완료 기준 (DoD)</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider col-status">상태</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider col-last-mod">최근 변경</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {PHASES.map(phase => {
                                            const phaseTasks = filteredTasks.filter(t => t.phase === phase.id);
                                            return (
                                                <React.Fragment key={phase.id}>
                                                    <tr className="bg-gray-50/50">
                                                        <td colSpan="6" className="px-6 py-2 text-xs font-bold text-gray-500 border-l-4 border-indigo-500 truncate">{phase.title}</td>
                                                    </tr>
                                                    {phaseTasks.length > 0 ? (
                                                        phaseTasks.map(task => (
                                                            <tr key={task.id} className="hover:bg-gray-50 transition-colors">
                                                                <td className="px-6 py-4 text-sm text-gray-900 flex items-center truncate">
                                                                    <Icons.CheckSquare size={16} className="text-gray-400 mr-2 flex-shrink-0" />
                                                                    <span className="truncate" title={task.task}>{task.task}</span>
                                                                </td>
                                                                <td className="px-6 py-4 text-sm text-gray-500 truncate">
                                                                    <div className="flex items-center">
                                                                        <Icons.User size={14} className="mr-1 text-gray-400 flex-shrink-0"/> {task.assignee?.display}
                                                                    </div>
                                                                </td>
                                                                <td className="px-6 py-4 text-xs text-gray-500 truncate">{task.start.slice(5)} ~ {task.end.slice(5)}</td>
                                                                <td className="px-6 py-4 text-xs text-gray-500 truncate" title={task.dod}>{task.dod}</td>
                                                                <td className="px-6 py-4 whitespace-nowrap">
                                                                    <select 
                                                                        value={task.status} 
                                                                        onChange={(e) => updateStatus(task.id, e.target.value)} 
                                                                        disabled={(!user && !demoMode)}
                                                                        className={`text-xs font-medium px-2.5 py-1 rounded-full border-0 cursor-pointer outline-none ring-1 ring-inset ${getStatusColor(task.status)} ${(!user && !demoMode) ? 'opacity-50 cursor-not-allowed' : ''}`}
                                                                    >
                                                                        <option value="Todo">Todo</option>
                                                                        <option value="In Progress">In Progress</option>
                                                                        <option value="Done">Done</option>
                                                                    </select>
                                                                </td>
                                                                <td className="px-6 py-4 text-xs text-gray-400 truncate">
                                                                    {task.updatedBy ? (
                                                                        <div title={`${task.updatedBy.name} (${task.updatedBy.email})`}>
                                                                            {task.updatedBy.name.split(' ')[0]}<br/>
                                                                            {formatDate(task.updatedAt)}
                                                                        </div>
                                                                    ) : '-'}
                                                                </td>
                                                            </tr>
                                                        ))
                                                    ) : (
                                                        <tr>
                                                            <td colSpan="6" className="px-6 py-4 text-xs text-gray-400 text-center italic">이 단계에 해당하는 태스크가 없습니다.</td>
                                                        </tr>
                                                    )}
                                                </React.Fragment>
                                            )
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                <div className="bg-white p-4 rounded-xl border shadow-sm text-sm text-gray-600 flex items-center">
                                    <Icons.AlertCircle size={16} className="text-orange-500 mr-2" />
                                    <span>팁: 상태(색상/패턴)가 실시간으로 반영됩니다. (초록: 완료, 파란 빗금: 진행중)</span>
                                </div>
                                <div className="overflow-x-auto border rounded-xl bg-white shadow-sm scrollbar-hide">
                                    <div className="min-w-[1200px]">
                                        <div className="flex border-b sticky top-0 bg-gray-50 z-20">
                                            <div className="w-64 flex-shrink-0 p-3 text-xs font-bold text-gray-500 uppercase tracking-wider border-r bg-gray-50 sticky left-0 z-30 bg-gray-50">Task Name</div>
                                            <div className="flex-1 flex">
                                                {['2025-12', '2026-01', '2026-02', '2026-03'].map(month => <div key={month} className="flex-1 border-r p-2 text-center text-xs font-bold text-gray-600 bg-gray-100">{month}</div>)}
                                            </div>
                                        </div>
                                        <div className="relative">
                                            <div className="absolute inset-0 flex ml-64 pointer-events-none">
                                                {['12','01','02','03'].map((_, i) => <div key={i} className="flex-1 border-r border-dashed border-gray-200 h-full"></div>)}
                                            </div>
                                            {filteredTasks.map((task) => {
                                                const startOffset = Math.ceil((new Date(task.start) - new Date('2025-12-18')) / (1000 * 60 * 60 * 24));
                                                const ganttTotal = Math.ceil((new Date('2026-03-31') - new Date('2025-12-18')) / (1000 * 60 * 60 * 24));
                                                const duration = Math.ceil((new Date(task.end) - new Date(task.start)) / (1000 * 60 * 60 * 24)) + 1;

                                                const leftPercent = (startOffset / ganttTotal) * 100;
                                                const widthPercent = (duration / ganttTotal) * 100;
                                                
                                                // 간트 차트: Phase 색상 대신 Status 색상 적용 (시각화 강화)
                                                // 요구사항: 상태별 시각 요소 추가
                                                const barClass = getGanttBarClass(task.status);

                                                return (
                                                    <div key={task.id} className="flex border-b hover:bg-gray-50 h-10 items-center relative group">
                                                        <div className="w-64 flex-shrink-0 px-4 text-sm text-gray-700 truncate font-medium border-r bg-white sticky left-0 z-10 flex items-center h-full shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
                                                            <span className={`w-2 h-2 rounded-full mr-2 ${task.status === 'Done' ? 'bg-green-500' : task.status === 'In Progress' ? 'bg-blue-500' : 'bg-gray-300'}`}></span>
                                                            {task.task}
                                                        </div>
                                                        <div className="flex-1 relative h-full flex items-center px-1">
                                                            <div 
                                                                className={`h-6 rounded-md shadow-sm text-[10px] flex items-center justify-center text-white truncate px-2 transition-all ${barClass}`} 
                                                                style={{ marginLeft: `${leftPercent}%`, width: `${widthPercent}%`, minWidth: '24px' }}
                                                                title={`${task.task} (${task.status})`}
                                                            >
                                                                {widthPercent > 5 && task.assignee?.display}
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                            {filteredTasks.length === 0 && (
                                                <div className="p-12 text-center text-gray-500 absolute w-full ml-64 top-0">
                                                    선택한 조건에 맞는 일정이 없습니다.
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ProjectDashboard />);
    </script>
</body>
</html>
