const { useState, useMemo, useRef, useEffect } = React;

// --- 아이콘 컴포넌트 ---
const Icon = ({ path, size = 18, className = "" }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        {path}
    </svg>
);

const Icons = {
    Clock: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} />,
    CheckSquare: (p) => <Icon {...p} path={<><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></>} />,
    BarChart2: (p) => <Icon {...p} path={<><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></>} />,
    ChevronRight: (p) => <Icon {...p} path={<polyline points="9 18 15 12 9 6"/>} />,
    AlertCircle: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>} />,
    CheckCircle2: (p) => <Icon {...p} path={<><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></>} />,
    User: (p) => <Icon {...p} path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />,
    Download: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></>} />,
    Printer: (p) => <Icon {...p} path={<><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></>} />,
    Filter: (p) => <Icon {...p} path={<><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></>} />,
    Refresh: (p) => <Icon {...p} path={<><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></>} />,
    Globe: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></>} />,
    Save: (p) => <Icon {...p} path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>} />
};

const PHASES = [
    { id: 'p0', title: 'Phase 0. 기획/법무/기술 선행 (리스크 차단)', color: 'bg-gray-100 text-gray-800', barColor: 'bg-gray-400' },
    { id: 'p1', title: 'Phase 1. 개발/마케팅 병행 (MVP & Identity)', color: 'bg-blue-50 text-blue-700', barColor: 'bg-blue-500' },
    { id: 'p2', title: 'Phase 2. 운영준비/데이터/안정화', color: 'bg-indigo-50 text-indigo-700', barColor: 'bg-indigo-500' },
    { id: 'p3', title: 'Phase 3. 행정/제안서 집중 (플랜B 포함)', color: 'bg-orange-50 text-orange-700', barColor: 'bg-orange-500' },
    { id: 'p4', title: 'Phase 4. 최종 마감/접수', color: 'bg-purple-50 text-purple-700', barColor: 'bg-purple-500' },
];

// 초기 데이터 (Seed)
const INITIAL_TASKS = [
    { id: '1', phase: 'p0', task: 'Kick-off 및 PoC 착수', assignee: { display: 'PM/Dev', roles: ['PM', 'Dev'] }, start: '2025-12-18', end: '2025-12-24', status: 'Done', dod: '회의록, PoC 계획' },
    { id: '2', phase: 'p0', task: '[기획] PRD/요구사항 확정 & 범위 컷라인', assignee: { display: 'Plan', roles: ['Plan'] }, start: '2025-12-19', end: '2025-12-31', status: 'In Progress', dod: 'PRD 1.0, 제외기능목록' },
    { id: '3', phase: 'p0', task: '[법무] 119 연계(자동배제) & 위치/개인정보 동의', assignee: { display: 'Legal', roles: ['Legal'] }, start: '2025-12-20', end: '2026-01-05', status: 'Done', dod: '책임정책, 동의 약관' },
    { id: '4', phase: 'p0', task: '[기술] 백그라운드 제약 검증 & 스토어 권한 설계', assignee: { display: 'Dev(Watch)', roles: ['Dev'] }, start: '2025-12-23', end: '2026-01-05', status: 'Todo', dod: '제약 체크, 권한 정의' },
    { id: '5', phase: 'p0', task: '[기획] 접근성/가독성(폰트/진동) 표준안', assignee: { display: 'Plan/Design', roles: ['Plan', 'Design'] }, start: '2026-01-02', end: '2026-01-05', status: 'Todo', dod: 'UX 가이드 표준안' },
    { id: '6', phase: 'p1', task: '[디자인] 워치 UI/UX (오탐 대응 포함)', assignee: { display: 'Design', roles: ['Design'] }, start: '2026-01-06', end: '2026-01-15', status: 'Todo', dod: 'Figma, 취소UX' },
    { id: '7', phase: 'p1', task: '[기획] 데이터 흐름도 & 파기/보관 정책', assignee: { display: 'Plan', roles: ['Plan'] }, start: '2026-01-06', end: '2026-01-15', status: 'Todo', dod: '개인정보 흐름도' },
    { id: '8', phase: 'p1', task: '[개발] 소리 인식 모델 최적화 (TFLite)', assignee: { display: 'Dev(Watch)', roles: ['Dev'] }, start: '2026-01-06', end: '2026-01-20', status: 'Todo', dod: '모델 파일 (.tflite)' },
    { id: '9', phase: 'p1', task: '[기획] 알림 문구/오탐 취소/책임고지 카피 확정', assignee: { display: 'Plan', roles: ['Plan'] }, start: '2026-01-10', end: '2026-01-17', status: 'Todo', dod: '문구 표준안, 화면매핑' },
    { id: '10', phase: 'p1', task: '[마케팅] 네이밍/메시지 (법무 검토 후 진행)', assignee: { display: 'Mkt', roles: ['Mkt'] }, start: '2026-01-11', end: '2026-01-17', status: 'Todo', dod: '브랜드 가이드(1p)' },
    { id: '11', phase: 'p1', task: '[개발] 최소 서버/로그/보호자 연동 API', assignee: { display: 'Dev(Server)', roles: ['Dev'] }, start: '2026-01-16', end: '2026-01-26', status: 'Todo', dod: 'API, 로그 스키마' },
    { id: '12', phase: 'p1', task: '[개발] 워치 알림/진동 로직 구현', assignee: { display: 'Dev(Watch)', roles: ['Dev'] }, start: '2026-01-16', end: '2026-01-26', status: 'Todo', dod: '기능 구현 완료' },
    { id: '13', phase: 'p2', task: '[운영] VOC 접수 채널/태깅/우선순위(SLA) 세팅', assignee: { display: 'Ops', roles: ['Ops'] }, start: '2026-01-27', end: '2026-02-05', status: 'Todo', dod: 'VOC시트, SLA정의' },
    { id: '14', phase: 'p2', task: '[운영] 베타 참여자 모집/동의/기기 지급/교육', assignee: { display: 'PM/Ops', roles: ['PM', 'Ops'] }, start: '2026-01-27', end: '2026-02-09', status: 'Todo', dod: '명단, 동의서, 기기전달' },
    { id: '15', phase: 'p2', task: '[테스트] KPI 산출(오탐률/반응속도/배터리/동작조건)', assignee: { display: 'QA', roles: ['QA'] }, start: '2026-02-01', end: '2026-02-12', status: 'Todo', dod: 'KPI표, 측정조건, 배터리 영향, 권한 제약' },
    { id: '16', phase: 'p2', task: '[운영] 설치/오탐 대응 가이드 (평가 대비)', assignee: { display: 'Ops', roles: ['Ops'] }, start: '2026-02-01', end: '2026-02-10', status: 'Todo', dod: '사용자 매뉴얼' },
    { id: '17', phase: 'p2', task: '[테스트] 통합 빌드 & 변수(거리/소음) 테스트', assignee: { display: 'QA/Dev', roles: ['QA', 'Dev'] }, start: '2026-02-01', end: '2026-02-09', status: 'Todo', dod: '시험 성적서/리포트' },
    { id: '18', phase: 'p2', task: '[운영] 베타 테스트 (사용자 데이터 확보)', assignee: { display: 'PM/Ops', roles: ['PM', 'Ops'] }, start: '2026-02-10', end: '2026-02-20', status: 'Todo', dod: '만족도 조사 결과' },
    { id: '19', phase: 'p2', task: '[마케팅] 평가용 데모 시나리오 & FAQ', assignee: { display: 'Mkt/Plan', roles: ['Mkt', 'Plan'] }, start: '2026-02-10', end: '2026-02-15', status: 'Todo', dod: '시연 시나리오' },
    { id: '20', phase: 'p3', task: '[행정] 공모 서류 체크리스트 & 원가 의뢰', assignee: { display: 'Admin/PM', roles: ['Admin', 'PM'] }, start: '2026-02-03', end: '2026-02-07', status: 'Todo', dod: '제출 리스트, 견적요청' },
    { id: '21', phase: 'p3', task: '[마케팅] 제안서/제품사양서/소개서 작성', assignee: { display: 'Mkt/Plan', roles: ['Mkt', 'Plan'] }, start: '2026-02-10', end: '2026-02-28', status: 'Todo', dod: '제안서, 카탈로그' },
    { id: '22', phase: 'p3', task: '[행정/PM] 평가 대응 Q&A 리스트 (심사위원용)', assignee: { display: 'PM/Mkt', roles: ['PM', 'Mkt'] }, start: '2026-02-15', end: '2026-02-25', status: 'Todo', dod: 'Q&A 20문 1장' },
    { id: '23', phase: 'p3', task: '[개발] 스토어 배포 & 심사 대응 (반려대비)', assignee: { display: 'Dev', roles: ['Dev'] }, start: '2026-02-15', end: '2026-02-28', status: 'Todo', dod: '심사 통과/소명자료' },
    { id: '24', phase: 'p3', task: '[행정] 원가계산 수령 or 약정서(플랜B)', assignee: { display: 'Admin', roles: ['Admin'] }, start: '2026-02-20', end: '2026-02-28', status: 'Todo', dod: '원가분석서/약정서' },
    { id: '25', phase: 'p3', task: '[행정] 제출 패키지 제작(제본/USB/인감)', assignee: { display: 'Admin', roles: ['Admin'] }, start: '2026-02-24', end: '2026-03-02', status: 'Todo', dod: '제출 패키지 완본' },
    { id: '26', phase: 'p4', task: '[마케팅] 평가 리허설 (데모/Q&A/정합성)', assignee: { display: 'Mkt/PM', roles: ['Mkt', 'PM'] }, start: '2026-03-01', end: '2026-03-03', status: 'Todo', dod: '리허설 완료' },
    { id: '27', phase: 'p4', task: '[행정] 최종 현장 접수 (대리인 위임장)', assignee: { display: 'Admin', roles: ['Admin'] }, start: '2026-03-04', end: '2026-03-07', status: 'Todo', dod: '접수증 (15:00 마감)' },
];

// --- 유틸리티 ---
const getStatusColor = (status) => {
    if (status === 'Done') return 'bg-green-100 text-green-700 border-green-200';
    if (status === 'In Progress') return 'bg-blue-100 text-blue-700 border-blue-200';
    return 'bg-gray-100 text-gray-500 border-gray-200';
};

const getGanttBarClass = (status) => {
    if (status === 'Done') return 'gantt-bar-done';
    if (status === 'In Progress') return 'gantt-bar-progress';
    return 'gantt-bar-todo';
};

const getDday = (target) => {
    const today = new Date();
    today.setHours(0,0,0,0);
    const targetDate = new Date(target);
    targetDate.setHours(0,0,0,0);
    return Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
};

// 인메모리 스토리지 (localStorage 대체)
const memoryStorage = {
    data: {},
    getItem(key) {
        return this.data[key] || null;
    },
    setItem(key, value) {
        this.data[key] = value;
    }
};

// --- 메인 컴포넌트 ---
function ProjectDashboard() {
    const [viewMode, setViewMode] = useState('gantt');
    const [tasks, setTasks] = useState(INITIAL_TASKS);
    const [saveMessage, setSaveMessage] = useState('');
    const dashboardRef = useRef(null);

    // 저장된 필터 불러오기 (인메모리)
    const loadSavedFilters = () => {
        const savedStatus = memoryStorage.getItem('wbs_statusFilter');
        const savedAssignee = memoryStorage.getItem('wbs_assigneeFilter');
        return {
            status: savedStatus ? JSON.parse(savedStatus) : { 'Todo': true, 'In Progress': true, 'Done': true },
            assignee: savedAssignee ? JSON.parse(savedAssignee) : null
        };
    };

    const savedFilters = loadSavedFilters();
    const [statusFilter, setStatusFilter] = useState(savedFilters.status);
    const [assigneeFilter, setAssigneeFilter] = useState(savedFilters.assignee || {});

    // 담당자 목록 추출
    const allAssignees = useMemo(() => {
        const assignees = new Set();
        tasks.forEach(t => {
            if (t.assignee && t.assignee.roles) {
                t.assignee.roles.forEach(r => assignees.add(r));
            }
        });
        return Array.from(assignees).sort();
    }, [tasks]);

    // 필터 초기화
    useEffect(() => {
        if (allAssignees.length > 0 && Object.keys(assigneeFilter).length === 0) {
            const initial = {};
            allAssignees.forEach(a => initial[a] = true);
            setAssigneeFilter(initial);
        }
    }, [allAssignees]);

    // 필터 변경 시 자동 저장
    useEffect(() => {
        memoryStorage.setItem('wbs_statusFilter', JSON.stringify(statusFilter));
        showSaveMessage();
    }, [statusFilter]);

    useEffect(() => {
        if (Object.keys(assigneeFilter).length > 0) {
            memoryStorage.setItem('wbs_assigneeFilter', JSON.stringify(assigneeFilter));
            showSaveMessage();
        }
    }, [assigneeFilter]);

    const showSaveMessage = () => {
        setSaveMessage('필터 저장됨');
        setTimeout(() => setSaveMessage(''), 1500);
    };

    // [상태 업데이트]
    const updateStatus = (id, newStatus) => {
        setTasks(prev => prev.map(task => 
            task.id === id ? { ...task, status: newStatus, updatedAt: new Date().toISOString(), updatedBy: { name: 'Guest', email: '' } } : task
        ));
    };

    // [필터 핸들러]
    const toggleStatusFilter = (status) => setStatusFilter(prev => ({ ...prev, [status]: !prev[status] }));
    const toggleAssigneeFilter = (assignee) => setAssigneeFilter(prev => ({ ...prev, [assignee]: !prev[assignee] }));
    const toggleAllAssignees = (checked) => {
        const next = {};
        allAssignees.forEach(a => next[a] = checked);
        setAssigneeFilter(next);
    };

    const filteredTasks = useMemo(() => {
        return tasks.filter(task => {
            if (!statusFilter[task.status]) return false;
            if (!task.assignee || !task.assignee.roles) return true;
            return task.assignee.roles.some(role => assigneeFilter[role]);
        });
    }, [tasks, statusFilter, assigneeFilter]);

    const progress = useMemo(() => {
        if (filteredTasks.length === 0) return 0;
        const done = filteredTasks.filter(t => t.status === 'Done').length;
        return Math.round((done / filteredTasks.length) * 100);
    }, [filteredTasks]);

    const targetDate = '2026-03-02';
    const dDay = getDday(targetDate);

    const currentPhase = useMemo(() => {
        const todayStr = new Date().toISOString().split('T')[0];
        const activeTask = tasks.find(t => t.start <= todayStr && t.end >= todayStr);
        
        if (activeTask) {
            const phase = PHASES.find(p => p.id === activeTask.phase);
            return { title: phase?.title.split('.')[0] || '준비', sub: phase?.title.split('.')[1] || '' };
        }
        
        const nextTask = tasks.find(t => t.start > todayStr);
        const nextPhase = nextTask ? PHASES.find(p => p.id === nextTask.phase) : null;
        return nextPhase 
            ? { title: nextPhase.title.split('.')[0] || '', sub: '(대기)' } 
            : { title: '완료', sub: '' };
    }, [tasks]);

    const formatDate = (ts) => {
        if (!ts) return '-';
        const date = new Date(ts);
        return `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}`;
    };

    return (
        <div className="min-h-screen bg-slate-50 p-4 md:p-6 font-sans text-gray-800" ref={dashboardRef}>
            <style>{`
                .scrollbar-hide::-webkit-scrollbar { display: none; }
                .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
                .gantt-bar-done { background-color: #22c55e; }
                .gantt-bar-progress { 
                    background: repeating-linear-gradient(45deg, #3b82f6, #3b82f6 10px, #60a5fa 10px, #60a5fa 20px);
                }
                .gantt-bar-todo { background-color: #9ca3af; opacity: 0.6; }
                .task-name-cell { min-width: 420px; max-width: 420px; width: 420px; }
                @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
                .save-toast { animation: fadeIn 0.3s ease-out; }
            `}</style>

            <div className="max-w-full mx-auto mb-8">
                {/* 저장 메시지 토스트 */}
                {saveMessage && (
                    <div className="fixed top-4 right-4 z-50 save-toast">
                        <div className="bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2">
                            <Icons.Save size={16} />
                            <span className="text-sm font-medium">{saveMessage}</span>
                        </div>
                    </div>
                )}

                {/* 상단 헤더 */}
                <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-6">
                    <div>
                        <h1 className="text-xl md:text-2xl font-bold text-gray-900 flex items-center">
                            <Icons.Clock className="mr-2 text-indigo-600" />
                            청각장애인 워치앱 프로젝트
                        </h1>
                        <p className="text-sm text-gray-500 mt-1">
                            <span className="font-bold text-indigo-600">Target: 3월 2일 (준비 완료)</span> | 접수마감: 3월 7일 15:00
                        </p>
                    </div>
                    <div className="flex flex-wrap bg-white p-1 rounded-lg border shadow-sm items-center gap-1">
                        <div className="flex items-center px-3 py-1 bg-gray-100 text-gray-600 rounded-md text-xs font-medium border border-gray-200">
                            <Icons.Globe size={14} className="mr-1"/> Demo Mode
                        </div>
                        <div className="w-px bg-gray-200 h-6 hidden md:block"></div>
                        <button onClick={() => setViewMode('list')} className={`px-3 py-2 text-sm font-medium rounded-md transition-all flex items-center ${viewMode === 'list' ? 'bg-indigo-50 text-indigo-700 shadow-sm' : 'text-gray-500 hover:bg-gray-50'}`}>
                            <Icons.CheckSquare size={16} className="mr-1"/> 리스트
                        </button>
                        <button onClick={() => setViewMode('gantt')} className={`px-3 py-2 text-sm font-medium rounded-md transition-all flex items-center ${viewMode === 'gantt' ? 'bg-indigo-50 text-indigo-700 shadow-sm' : 'text-gray-500 hover:bg-gray-50'}`}>
                            <Icons.BarChart2 size={16} className="mr-1"/> 간트
                        </button>
                    </div>
                </div>

                {/* 필터 영역 */}
                <div className="bg-white p-4 rounded-xl border shadow-sm mb-6">
                    <div className="flex flex-col lg:flex-row gap-6">
                        <div className="flex-1">
                            <h4 className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 flex items-center">
                                <Icons.Filter size={12} className="mr-1"/> 상태 필터
                                <span className="ml-2 text-green-500 text-[10px] font-normal">(자동 저장)</span>
                            </h4>
                            <div className="flex flex-wrap gap-3">
                                {['Todo', 'In Progress', 'Done'].map(status => (
                                    <label key={status} className="inline-flex items-center text-sm cursor-pointer select-none hover:bg-gray-50 px-2 py-1 rounded transition-colors">
                                        <input type="checkbox" className="form-checkbox h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500" checked={statusFilter[status]} onChange={() => toggleStatusFilter(status)}/>
                                        <span className="ml-2 text-gray-700">{status}</span>
                                    </label>
                                ))}
                            </div>
                        </div>
                        <div className="flex-[2]">
                            <div className="flex justify-between items-center mb-2">
                                <h4 className="text-xs font-bold text-gray-500 uppercase tracking-wider flex items-center">
                                    <Icons.User size={12} className="mr-1"/> 담당자 필터
                                    <span className="ml-2 text-green-500 text-[10px] font-normal">(자동 저장)</span>
                                </h4>
                                <div className="space-x-2 text-xs">
                                    <button onClick={() => toggleAllAssignees(true)} className="text-indigo-600 hover:underline">전체 선택</button>
                                    <span className="text-gray-300">|</span>
                                    <button onClick={() => toggleAllAssignees(false)} className="text-gray-500 hover:underline">전체 해제</button>
                                </div>
                            </div>
                            <div className="flex flex-wrap gap-x-4 gap-y-2">
                                {allAssignees.map(assignee => (
                                    <label key={assignee} className="inline-flex items-center text-sm cursor-pointer select-none hover:bg-gray-50 px-2 py-1 rounded transition-colors">
                                        <input type="checkbox" className="form-checkbox h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500" checked={assigneeFilter[assignee] || false} onChange={() => toggleAssigneeFilter(assignee)}/>
                                        <span className="ml-2 text-gray-700">{assignee}</span>
                                    </label>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>

                {/* 상태 카드 */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-start space-x-4">
                        <div className="p-3 rounded-lg bg-blue-100 text-blue-600"><Icons.ChevronRight size={24}/></div>
                        <div>
                            <p className="text-sm text-gray-500 font-medium">현재 진행 단계</p>
                            <h3 className="text-xl font-bold text-gray-800 mt-1">{currentPhase.title}</h3>
                            <p className="text-xs text-gray-400 mt-1">{currentPhase.sub}</p>
                        </div>
                    </div>
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-start space-x-4">
                        <div className="p-3 rounded-lg bg-green-100 text-green-600"><Icons.CheckCircle2 size={24}/></div>
                        <div>
                            <p className="text-sm text-gray-500 font-medium">선택 항목 진행률</p>
                            <h3 className="text-xl font-bold text-gray-800 mt-1">{progress}%</h3>
                            <p className="text-xs text-gray-400 mt-1">{filteredTasks.filter(t => t.status === 'Done').length} / {filteredTasks.length} 완료</p>
                        </div>
                    </div>
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-start space-x-4">
                        <div className="p-3 rounded-lg bg-orange-100 text-orange-600"><Icons.AlertCircle size={24}/></div>
                        <div>
                            <p className="text-sm text-gray-500 font-medium">D-Day (준비완료)</p>
                            <h3 className="text-xl font-bold text-gray-800 mt-1">D{dDay >= 0 ? '-' + dDay : '+' + Math.abs(dDay)}</h3>
                            <p className="text-xs text-gray-400 mt-1">목표일: 2026-03-02</p>
                        </div>
                    </div>
                </div>

                {/* 메인 뷰 */}
                {viewMode === 'list' ? (
                    <div className="bg-white rounded-xl shadow-sm border overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style={{minWidth: '320px'}}>Phase / Task</th>
                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style={{width: '100px'}}>담당자</th>
                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style={{width: '120px'}}>기간</th>
                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style={{width: '180px'}}>완료 기준</th>
                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style={{width: '120px'}}>상태</th>
                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style={{width: '100px'}}>최근 변경</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {PHASES.map(phase => {
                                    const phaseTasks = filteredTasks.filter(t => t.phase === phase.id);
                                    return (
                                        <React.Fragment key={phase.id}>
                                            <tr className="bg-gray-50/50">
                                                <td colSpan="6" className="px-4 py-2 text-xs font-bold text-gray-500 border-l-4 border-indigo-500">{phase.title}</td>
                                            </tr>
                                            {phaseTasks.length > 0 ? (
                                                phaseTasks.map(task => (
                                                    <tr key={task.id} className="hover:bg-gray-50 transition-colors">
                                                        <td className="px-4 py-3 text-sm text-gray-900">
                                                            <div className="flex items-center">
                                                                <Icons.CheckSquare size={14} className="text-gray-400 mr-2 flex-shrink-0" />
                                                                <span>{task.task}</span>
                                                            </div>
                                                        </td>
                                                        <td className="px-4 py-3 text-sm text-gray-500">
                                                            <div className="flex items-center">
                                                                <Icons.User size={12} className="mr-1 text-gray-400"/> {task.assignee?.display}
                                                            </div>
                                                        </td>
                                                        <td className="px-4 py-3 text-xs text-gray-500">{task.start.slice(5)} ~ {task.end.slice(5)}</td>
                                                        <td className="px-4 py-3 text-xs text-gray-500">{task.dod}</td>
                                                        <td className="px-4 py-3 whitespace-nowrap">
                                                            <select 
                                                                value={task.status} 
                                                                onChange={(e) => updateStatus(task.id, e.target.value)} 
                                                                className={`text-xs font-medium px-2.5 py-1 rounded-full border-0 cursor-pointer outline-none ring-1 ring-inset ${getStatusColor(task.status)}`}
                                                            >
                                                                <option value="Todo">Todo</option>
                                                                <option value="In Progress">In Progress</option>
                                                                <option value="Done">Done</option>
                                                            </select>
                                                        </td>
                                                        <td className="px-4 py-3 text-xs text-gray-400">
                                                            {task.updatedBy ? (
                                                                <div>
                                                                    {task.updatedBy.name}<br/>
                                                                    {formatDate(task.updatedAt)}
                                                                </div>
                                                            ) : '-'}
                                                        </td>
                                                    </tr>
                                                ))
                                            ) : (
                                                <tr>
                                                    <td colSpan="6" className="px-4 py-3 text-xs text-gray-400 text-center italic">이 단계에 해당하는 태스크가 없습니다.</td>
                                                </tr>
                                            )}
                                        </React.Fragment>
                                    )
                                })}
                            </tbody>
                        </table>
                    </div>
                ) : (
                    <div className="space-y-4">
                        <div className="bg-white p-3 rounded-xl border shadow-sm text-sm text-gray-600 flex items-center">
                            <Icons.AlertCircle size={16} className="text-orange-500 mr-2 flex-shrink-0" />
                            <span>상태별 색상: 초록(완료), 파란 빗금(진행중), 회색(예정)</span>
                        </div>
                        <div className="overflow-x-auto border rounded-xl bg-white shadow-sm scrollbar-hide">
                            <div style={{minWidth: '1400px'}}>
                                {/* 간트 헤더 */}
                                <div className="flex border-b sticky top-0 bg-gray-50 z-20">
                                    <div className="task-name-cell flex-shrink-0 p-3 text-xs font-bold text-gray-500 uppercase tracking-wider border-r bg-gray-50 sticky left-0 z-30">
                                        Task Name
                                    </div>
                                    <div className="flex-1 flex">
                                        {['2025-12', '2026-01', '2026-02', '2026-03'].map(month => (
                                            <div key={month} className="flex-1 border-r p-2 text-center text-xs font-bold text-gray-600 bg-gray-100">{month}</div>
                                        ))}
                                    </div>
                                </div>
                                {/* 간트 본문 */}
                                <div className="relative">
                                    <div className="absolute inset-0 flex pointer-events-none" style={{marginLeft: '420px'}}>
                                        {['12','01','02','03'].map((_, i) => <div key={i} className="flex-1 border-r border-dashed border-gray-200 h-full"></div>)}
                                    </div>
                                    {filteredTasks.map((task) => {
                                        const startOffset = Math.ceil((new Date(task.start) - new Date('2025-12-18')) / (1000 * 60 * 60 * 24));
                                        const ganttTotal = Math.ceil((new Date('2026-03-31') - new Date('2025-12-18')) / (1000 * 60 * 60 * 24));
                                        const duration = Math.ceil((new Date(task.end) - new Date(task.start)) / (1000 * 60 * 60 * 24)) + 1;

                                        const leftPercent = (startOffset / ganttTotal) * 100;
                                        const widthPercent = (duration / ganttTotal) * 100;
                                        const barClass = getGanttBarClass(task.status);

                                        return (
                                            <div key={task.id} className="flex border-b hover:bg-gray-50 h-10 items-center relative group">
                                                <div className="task-name-cell flex-shrink-0 px-4 text-sm text-gray-700 font-medium border-r bg-white sticky left-0 z-10 flex items-center h-full shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
                                                    <span className={`w-2 h-2 rounded-full mr-2 flex-shrink-0 ${task.status === 'Done' ? 'bg-green-500' : task.status === 'In Progress' ? 'bg-blue-500' : 'bg-gray-300'}`}></span>
                                                    <span className="truncate">{task.task}</span>
                                                </div>
                                                <div className="flex-1 relative h-full flex items-center px-1">
                                                    <div 
                                                        className={`h-6 rounded-md shadow-sm text-[10px] flex items-center justify-center text-white truncate px-2 transition-all ${barClass}`} 
                                                        style={{ marginLeft: `${leftPercent}%`, width: `${widthPercent}%`, minWidth: '24px' }}
                                                        title={`${task.task} (${task.status})`}
                                                    >
                                                        {widthPercent > 5 && task.assignee?.display}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                    {filteredTasks.length === 0 && (
                                        <div className="p-12 text-center text-gray-500" style={{marginLeft: '420px'}}>
                                            선택한 조건에 맞는 일정이 없습니다.
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
}

export default ProjectDashboard;
